name: Release macOS App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write
  packages: write

env:
  APP_NAME: BilibiliStreamHelper
  SCHEME_NAME: BilibiliStreamHelper
  CONFIGURATION: Release

jobs:
  build:
    runs-on: macos-26
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.0'
    
    - name: Set up environment variables
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
        fi
        echo "BUILD_NUMBER=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV
        echo "ARCHIVE_PATH=${{ runner.temp }}/${{ env.APP_NAME }}.xcarchive" >> $GITHUB_ENV
        echo "EXPORT_PATH=${{ runner.temp }}/export" >> $GITHUB_ENV

    - name: Cache Swift Package Manager
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          .build
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Resolve Swift packages
      run: |
        xcodebuild -resolvePackageDependencies -project ${{ env.APP_NAME }}.xcodeproj -scheme ${{ env.SCHEME_NAME }}

    - name: Update build number and version
      run: |
        # Update version and build number in project.pbxproj
        sed -i '' "s/MARKETING_VERSION = [^;]*/MARKETING_VERSION = ${VERSION#v}/" ${{ env.APP_NAME }}.xcodeproj/project.pbxproj
        sed -i '' "s/CURRENT_PROJECT_VERSION = [^;]*/CURRENT_PROJECT_VERSION = $BUILD_NUMBER/" ${{ env.APP_NAME }}.xcodeproj/project.pbxproj

    - name: Build and Archive
      run: |
        xcodebuild archive \
          -project ${{ env.APP_NAME }}.xcodeproj \
          -scheme ${{ env.SCHEME_NAME }} \
          -configuration ${{ env.CONFIGURATION }} \
          -archivePath "$ARCHIVE_PATH" \
          -destination "generic/platform=macOS" \
          -allowProvisioningUpdates \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Export Archive
      run: |
        mkdir -p "$EXPORT_PATH"
        
        # Create ExportOptions.plist
        cat > "${{ runner.temp }}/ExportOptions.plist" << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>mac-application</string>
            <key>destination</key>
            <string>export</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>stripSwiftSymbols</key>
            <true/>
        </dict>
        </plist>
        EOF
        
        xcodebuild -exportArchive \
          -archivePath "$ARCHIVE_PATH" \
          -exportOptionsPlist "${{ runner.temp }}/ExportOptions.plist" \
          -exportPath "$EXPORT_PATH" \
          -allowProvisioningUpdates

    - name: Create DMG
      run: |
        APP_PATH="$EXPORT_PATH/$APP_NAME.app"
        DMG_PATH="${{ runner.temp }}/$APP_NAME-$VERSION-macos.dmg"
        
        # Create temporary directory for DMG content
        DMG_TEMP_DIR="${{ runner.temp }}/dmg_temp"
        mkdir -p "$DMG_TEMP_DIR"
        
        # Copy app to temp directory
        cp -R "$APP_PATH" "$DMG_TEMP_DIR/"
        
        # Create DMG
        hdiutil create -volname "$APP_NAME $VERSION" \
          -srcfolder "$DMG_TEMP_DIR" \
          -ov -format UDZO \
          "$DMG_PATH"
        
        echo "DMG_PATH=$DMG_PATH" >> $GITHUB_ENV

    - name: Create ZIP archive
      run: |
        APP_PATH="$EXPORT_PATH/$APP_NAME.app"
        ZIP_PATH="${{ runner.temp }}/$APP_NAME-$VERSION-macos.zip"
        
        cd "$EXPORT_PATH"
        zip -r "$ZIP_PATH" "$APP_NAME.app"
        
        echo "ZIP_PATH=$ZIP_PATH" >> $GITHUB_ENV

    - name: Generate Release Notes
      run: |
        # å¤åˆ¶æ¨¡æ¿æ–‡ä»¶å¹¶æ›¿æ¢å ä½ç¬¦
        cp .github/release_template.md "${{ runner.temp }}/release_notes.md"
        
        # æå–å½“å‰ç‰ˆæœ¬çš„ CHANGELOG å†…å®¹
        VERSION_NUMBER="${{ env.VERSION }}"
        # ç§»é™¤ç‰ˆæœ¬å·å‰çš„ 'v' å‰ç¼€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        VERSION_CLEAN=${VERSION_NUMBER#v}
        
        # ä» CHANGELOG.md æå–å½“å‰ç‰ˆæœ¬çš„å†…å®¹
        if [ -f "CHANGELOG.md" ]; then
          # æŸ¥æ‰¾å½“å‰ç‰ˆæœ¬çš„å¼€å§‹è¡Œ
          START_LINE=$(grep -n "## \[$VERSION_CLEAN\]" CHANGELOG.md | head -1 | cut -d: -f1)
          
          if [ -n "$START_LINE" ]; then
            # æŸ¥æ‰¾ä¸‹ä¸€ä¸ªç‰ˆæœ¬æ ‡è®°çš„è¡Œå·ï¼ˆä½œä¸ºç»“æŸè¡Œï¼‰
            END_LINE=$(tail -n +$((START_LINE + 1)) CHANGELOG.md | grep -n "^## \[" | head -1 | cut -d: -f1)
            
            if [ -n "$END_LINE" ]; then
              # è®¡ç®—å®é™…çš„ç»“æŸè¡Œå·
              END_LINE=$((START_LINE + END_LINE - 1))
              # æå–ç‰ˆæœ¬å†…å®¹ï¼ˆè·³è¿‡ç‰ˆæœ¬æ ‡é¢˜è¡Œï¼‰
              CHANGELOG_CONTENT=$(sed -n "$((START_LINE + 1)),$((END_LINE - 1))p" CHANGELOG.md)
            else
              # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬ï¼Œæå–åˆ°æ–‡ä»¶æœ«å°¾
              CHANGELOG_CONTENT=$(tail -n +$((START_LINE + 1)) CHANGELOG.md)
            fi
          else
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å½“å‰ç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤å†…å®¹
            CHANGELOG_CONTENT="## ğŸš€ æ–°åŠŸèƒ½\n- è¯·æŸ¥çœ‹å®Œæ•´çš„ CHANGELOG.md è·å–è¯¦ç»†ä¿¡æ¯\n\n## ğŸ”§ æ”¹è¿›\n- æ€§èƒ½ä¼˜åŒ–å’Œé”™è¯¯ä¿®å¤"
          fi
        else
          # å¦‚æœæ²¡æœ‰ CHANGELOG.md æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤å†…å®¹
          CHANGELOG_CONTENT="## ğŸš€ æ–°åŠŸèƒ½\n- æœ€æ–°ç‰ˆæœ¬å‘å¸ƒ\n\n## ğŸ”§ æ”¹è¿›\n- æ€§èƒ½ä¼˜åŒ–å’Œé”™è¯¯ä¿®å¤"
        fi
        
        # å°† CHANGELOG å†…å®¹å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼Œå¤„ç†æ¢è¡Œç¬¦
        echo -e "$CHANGELOG_CONTENT" > "${{ runner.temp }}/changelog_content.txt"
        
        # æ›¿æ¢æ¨¡æ¿ä¸­çš„å ä½ç¬¦ï¼ˆä½¿ç”¨ä¸åŒçš„åˆ†éš”ç¬¦é¿å…æ–œæ å†²çªï¼‰
        sed -i '' "s|{{APP_NAME}}|${{ env.APP_NAME }}|g" "${{ runner.temp }}/release_notes.md"
        sed -i '' "s|{{VERSION}}|${{ env.VERSION }}|g" "${{ runner.temp }}/release_notes.md"
        sed -i '' "s|{{BUILD_NUMBER}}|${{ env.BUILD_NUMBER }}|g" "${{ runner.temp }}/release_notes.md"
        sed -i '' "s|{{RELEASE_DATE}}|$(date '+%Y-%m-%d %H:%M:%S UTC')|g" "${{ runner.temp }}/release_notes.md"
        sed -i '' "s|{{REPOSITORY}}|${{ github.repository }}|g" "${{ runner.temp }}/release_notes.md"
        
        # æ›¿æ¢ CHANGELOG å†…å®¹å ä½ç¬¦
        # ä½¿ç”¨ awk æ¥å¤„ç†å¤šè¡Œæ›¿æ¢
        awk '
        /{{CHANGELOG_CONTENT}}/ {
          while ((getline line < "'${{ runner.temp }}'/changelog_content.txt") > 0) {
            print line
          }
          close("'${{ runner.temp }}'/changelog_content.txt")
          next
        }
        {print}
        ' "${{ runner.temp }}/release_notes.md" > "${{ runner.temp }}/release_notes_final.md"
        
        # æ›¿æ¢åŸæ–‡ä»¶
        mv "${{ runner.temp }}/release_notes_final.md" "${{ runner.temp }}/release_notes.md"

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.VERSION }}
        name: ${{ env.APP_NAME }} ${{ env.VERSION }}
        body_path: ${{ runner.temp }}/release_notes.md
        draft: false
        prerelease: false
        files: |
          ${{ env.DMG_PATH }}
          ${{ env.ZIP_PATH }}
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-${{ env.VERSION }}-artifacts
        path: |
          ${{ env.DMG_PATH }}
          ${{ env.ZIP_PATH }}
        retention-days: 30
